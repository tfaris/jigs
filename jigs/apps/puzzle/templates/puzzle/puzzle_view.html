<html>
    <head>
        <style>
            #puzzle{
                width:100%;
                height:100%;
                border:1px solid;
            }
        </style>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.min.js"></script>        
        <script type="text/javascript">
            var pieces = [],pieceDict={},
                cvOrigin = [0,0],mouseStart=[0,0],mouseEnd=[0,0],mouseDown=false,
                zoom = 1,
                selectedObject=null;
            function puzzleUpdate()
            {
                var data = {
                    session:"{{session.pk}}"
                };
                if (mouseDown){
                    for (var i=0;i<pieces.length;i++){
                        var piece = pieces[i];
                        data["sessp"+piece.id] = [piece.offsetX,piece.offsetY];
                    }
                }
                console.log(data);
                $.ajax({
                  type: "POST",
                  url: "status/",
                  data: JSON.stringify(data),
                  success: function(json){
                        for (var piece_id in json){
                            if (!selectedObject || (selectedObject && piece_id != selectedObject.id)){
                                var offset = json[piece_id];
                                pieceDict[piece_id].offsetX = offset[0];
                                pieceDict[piece_id].offsetY = offset[1];
                            }
                        }
                        Draw(puzzle);
                  },
                  dataType: "json"
                });            
            
                //$.getJSON("status/", {session:"{{session.pk}}"}, function(json){
                //   for (var piece_id in json){
                //       var offset = json[piece_id];
                //       pieceDict[piece_id].offsetX = offset[0];
                //       pieceDict[piece_id].offsetY = offset[1];
                //   }
                //   Draw(puzzle);
                //});
            }
            function Draw(canvas)
            {
                // Clear the canvas first
                canvas.width = canvas.width
                var ctx = canvas.getContext('2d');
                ctx.scale(zoom,zoom);
                ctx.translate(cvOrigin[0],cvOrigin[1]);
                for (var i=0;i<pieces.length;i++){
                    var piece = pieces[i];
                    ctx.drawImage(piece.image,piece.offsetX,piece.offsetY,piece.width,piece.height);
                    if (piece == selectedObject){
                        ctx.strokeStyle = '#ff0';
                    }else{
                        ctx.strokeStyle = '#000';
                    }
                    ctx.strokeRect(piece.offsetX,piece.offsetY,piece.width,piece.height);                    
                }
                
                for (var i=0;i<pieces.length;i++){
                    var piece = pieces[i];
                    ctx.fillStyle = '#ff0';
                    ctx.fillText(piece.id,piece.offsetX,piece.offsetY+40);
                }
            }
            $(document).ready(function(){
                var canvas = $("#puzzle")[0];
                {%for sess_piece in session.puzzlesessionpiece_set.all%}
                    var piece={};
                    piece.image = new Image();
                    piece.image.src = "/media/{{sess_piece.piece.path}}";
                    piece.id = {{sess_piece.piece.pk}};
                    piece.offsetX = {{sess_piece.x}};
                    piece.offsetY = {{sess_piece.y}};
                    piece.width = {{sess_piece.piece.width}};
                    piece.height = {{sess_piece.piece.height}};
                    pieceDict[{{sess_piece.piece.pk}}] = piece;
                    piece.image.onload = function(){
                        Draw(canvas);
                    }
                    pieces.push(piece);
                {%endfor%}                
                
                $("#puzzle").mousedown(function (e)
                {    
                    var mouseXY = [e.pageX,e.pageY],
                        pieceHit = false,
                        x = mouseXY[0]/zoom,
                        y = mouseXY[1]/zoom;
                    mouseStart = mouseXY;
                    mouseDown = true;
                    console.log([x,y]);
                    for (var i=0;i<pieces.length;i++){
                        var piece = pieces[i],
                            bounds = [(cvOrigin[0]+piece.offsetX),(cvOrigin[1]+piece.offsetY),
                                      (cvOrigin[0]+piece.offsetX+piece.width),(cvOrigin[1]+piece.offsetY+piece.height)];
                        if (x >= bounds[0] && x <= bounds[2] &&
                            y >= bounds[1] && y <= bounds[3])
                            {
                                pieceHit = true;
                                selectedObject=piece;
                                // Move piece to the end of the list so it gets drawn
                                // on top.
                                pieces.splice(i,1);
                                pieces.push(selectedObject);
                                Draw(canvas);
                                break;
                            }
                    }
                    if (!pieceHit){
                        selectedObject = null;
                    }
                });
                $("#puzzle").mousemove(function (e)
                {
                    if (mouseDown){
                        var mouseXY = [e.pageX,e.pageY];
                        var diffX = mouseXY[0] - mouseStart[0];
                        var diffY = mouseXY[1] - mouseStart[1];
                        if (selectedObject) {
                            selectedObject.offsetX += diffX/zoom;
                            selectedObject.offsetY += diffY/zoom;
                        }
                        else{
                            cvOrigin[0] += diffX*1.5/(zoom>0?zoom:1);
                            cvOrigin[1] += diffY*1.5/(zoom>0?zoom:1);
                        }
                        mouseStart = mouseXY;
                        Draw(canvas);
                    }
                });
                window.onmouseup = function (e)
                {
                    mouseDown = false;
                    selectedObject = null;
                    Draw(canvas)
                }
                canvas.onmousewheel = function(event){
                    var mousex = event.clientX - canvas.offsetLeft;
                    var mousey = event.clientY - canvas.offsetTop;
                    var wheel = event.wheelDelta/120;
                    if (event.wheelDelta > 0)
                    {
                        zoom *= 1.3;
                    }
                    else
                    {
                        zoom /= 1.3;
                    }
                    Draw(canvas);
                };
                
                window.addEventListener('resize', resizeCanvas, false);
                function resizeCanvas() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    Draw(canvas); 
                }
                resizeCanvas();
                window.setInterval(puzzleUpdate,1000);
            });
        </script>
    </head>
    <body>
        {%comment%}
        {%for piece in puzzle.puzzlepiece_set.all%}
            <img src="/media/{{piece.path}}"/>
        {%endfor%}
        {%endcomment%}
        
        
        <canvas id="puzzle"></canvas>
    </body>
</html>   
